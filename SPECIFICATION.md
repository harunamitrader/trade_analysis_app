# Streamlit取引履歴分析アプリ仕様書

## 1. 概要

GMOクリック証券からダウンロードした取引履歴CSVファイルをアップロードすることで、取引成績を自動で集計・可視化するWebアプリケーション。

## 2. 使用技術

- **言語:** Python
- **フレームワーク:** Streamlit
- **ライブラリ:** Pandas

## 3. 機能要件

### 3.1. ファイルアップロード機能
- ユーザーはWebページのメイン画面からCSVファイルをアップロードできる。
- アップロードされたファイルはShift-JIS形式を想定し、アプリケーション側でUTF-8に変換して処理する。

### 3.2. データ解析・集計機能
- アップロードされたCSVデータをPandas DataFrameとして読み込む。
- **決済取引の抽出:**
  - 「取引区分」が`決済`または`ロスカット`を含むすべての取引を分析のベースとする。
- **新規・決済の関連付けと保有時間の計算:**
  - 各決済取引に対し、ファイル内に対応する新規取引が存在する場合（FIFO方式、約定数量考慮）、**保有時間**を計算する。
  - **対応する新規取引が見つからない決済取引**も、損益や勝率などの計算には含めるが、平均保有時間の計算からは除外する。
- **ロング/ショートの判定:**
  - 決済取引の`売買区分`を基に判定する。
- **ロット数の正規化:**
  - FX取引は**10,000通貨を1ロット**として換算する。
  - CFD取引は**数量1を1ロット**として扱う。
- **統計指標の計算:**
  - 各指標を、FXとCFDで完全に分離して計算する。
  - **1週間あたりのトレード回数:** FXとCFDの合計サマリーに表示する。

### 3.3. 結果表示機能
- **表示フォーマット:**
  - **テーブルヘッダー:** 項目名を2行に分けて表示し、テーブルの横幅を削減する。
  - **平均保有時間:** `○日○時間○分`の形式で表示する。
  - **数値フォーマット:**
    - 整数: 総損益、取引回数、勝ち/負けトレード数、総利益/損失
    - 小数点第一位: 勝率、平均利益/損失、1ロットあたり平均利益/損失
    - 小数点第二位: プロフィットファクター、リスクリワードレシオ
  - **条件付き色分け:**
    - `総損益`, `売買損益`, `スワップ`: プラスは青、マイナスは赤。
    - `勝率`: 50%以上は青、50%未満は赤。
    - `PF`, `RR`: 1以上は青、1未満は赤。
- **FXサマリー:**
  - **FX 合計サマリー:** 全FX取引の合計成績を表示。
  - **FX 月別サマリー:** 決済年月ごとにFX取引の成績を表示。
  - **FX 月別累積損益グラフ:** 月別の**総損益とスワップ損益を合算した**累積額を折れ線グラフで表示する。
  - **FX 日別累積損益グラフ:** 日別の**総損益とスワップ損益を合算した**累積額を折れ線グラフで表示する。
  - **FX 銘柄別サマリー:** 銘柄とポジションごとにFX取引の成績を表示。
- **CFDサマリー:**
  - **CFD 合計サマリー:** 全CFD取引の合計成績を表示。
  - **CFD 月別サマリー:** 決済年月ごとにCFD取引の成績を表示する。
  - **CFD 月別累積損益グラフ:** 月別の総損益の累積を折れ線グラフで表示する。
  - **CFD 日別累積損益グラフ:** 日別の総損益の累積を折れ線グラフで表示する。
  - **CFD 銘柄別サマリー:** 銘柄とポジションごとにCFD取引の成績を表示する。

## 4. 画面設計 (Streamlitコンポーネント)

- **`st.title`**: アプリケーションのタイトル。
- **`st.file_uploader`**: メイン画面のファイルアップローダー。
- **`st.subheader`**: 各セクションのタイトル。
- **`st.dataframe`**: 集計結果のテーブル表示に使用。
- **`st.line_chart`**: 累積損益グラフの表示に使用。
